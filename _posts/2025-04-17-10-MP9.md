---
layout: post
title: "[ë§ˆí”„] Cortex-M ì˜ˆì™¸ ë° Reset ì‹œìŠ¤í…œ ì„¤ëª…"
category: education
---

# ğŸ“˜ Cortex-M ì˜ˆì™¸ ë° Reset ì‹œìŠ¤í…œ ì„¤ëª…

---

## âœ… 1. ì˜ˆì™¸(Exception)ë€?

Cortex-Mì—ì„œ ì˜ˆì™¸ë€ **í”„ë¡œì„¸ì„œê°€ ì¼ë°˜ì ì¸ ëª…ë ¹ì–´ ì‹¤í–‰ íë¦„ì„ ì ì‹œ ë©ˆì¶”ê³  ì²˜ë¦¬í•´ì•¼ í•  ì‚¬ê±´**ì„ ì˜ë¯¸í•œë‹¤.  
ì´ì—ëŠ” í•˜ë“œì›¨ì–´ ì¸í„°ëŸ½íŠ¸, ì‹œìŠ¤í…œ ì˜¤ë¥˜(Fault), ì‹œìŠ¤í…œ ì½œ(SVC), ê·¸ë¦¬ê³  Resetë„ í¬í•¨ëœë‹¤.

ì˜ˆì™¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìœ í˜•ìœ¼ë¡œ ë‚˜ë‰œë‹¤:

- **System Exception**: Reset, NMI, HardFault, MemManage ë“± (ì˜ˆì™¸ ë²ˆí˜¸ 1~15)
- **Interrupt (IRQ)**: ì™¸ë¶€ ì¥ì¹˜ì—ì„œ ì˜¤ëŠ” ì¸í„°ëŸ½íŠ¸ (ì˜ˆì™¸ ë²ˆí˜¸ 16 ì´ìƒ)

Cortex-Mì€ ì´ ëª¨ë“  ì˜ˆì™¸ë¥¼ í•˜ë‚˜ì˜ ê³µí†µëœ ë©”ì»¤ë‹ˆì¦˜ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

---

## âœ… 2. ì˜ˆì™¸ ë²ˆí˜¸ì™€ CMSIS í‘œí˜„ ë°©ì‹

- ëª¨ë“  ì˜ˆì™¸ì—ëŠ” ê³ ìœ  ë²ˆí˜¸ê°€ ìˆìŒ. ì´ ë²ˆí˜¸ëŠ” `IPSR` ë ˆì§€ìŠ¤í„°ë¥¼ í†µí•´ í™•ì¸ ê°€ëŠ¥.
- CMSISì—ì„œëŠ” í¸ì˜ìƒ:
  - System Exception: **ìŒìˆ˜ ê°’**ìœ¼ë¡œ í‘œí˜„ (`#define HardFault_IRQn -13`)
  - IRQ(ì™¸ë¶€ ì¸í„°ëŸ½íŠ¸): **ì–‘ìˆ˜ ê°’**ìœ¼ë¡œ í‘œí˜„ (`#define TIM2_IRQn 28`)

---

## âœ… 3. ë²¡í„° í…Œì´ë¸” (Vector Table)

ë²¡í„° í…Œì´ë¸”ì€ ëª¨ë“  ì˜ˆì™¸ì— ëŒ€í•œ **í•¸ë“¤ëŸ¬ ì£¼ì†Œë¥¼ ì €ì¥í•œ í…Œì´ë¸”**ì´ë©°, ì´ˆê¸°í™” ì‹œ ê°€ì¥ ë¨¼ì € ì°¸ì¡°ë˜ëŠ” êµ¬ì¡°ì´ë‹¤.

- ë©”ëª¨ë¦¬ ì£¼ì†Œ `0x0000_0000`ë¶€í„° ì‹œì‘
- ì²« ë²ˆì§¸ í•­ëª©: ì´ˆê¸° Stack Pointer (MSP ì´ˆê¸°ê°’)
- ë‘ ë²ˆì§¸ ì´í›„: ì˜ˆì™¸ ë²ˆí˜¸ ìˆœìœ¼ë¡œ í•¸ë“¤ëŸ¬ ì£¼ì†Œ

ì˜ˆ:
```
0x0000_0000 â†’ ì´ˆê¸° ìŠ¤íƒ í¬ì¸í„°
0x0000_0004 â†’ Reset_Handler
0x0000_0008 â†’ NMI_Handler
0x0000_000C â†’ HardFault_Handler
...
```

- `VTOR` (Vector Table Offset Register)ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ ìœ„ì¹˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŒ (ì˜ˆ: ë¶€íŠ¸ë¡œë” â†’ ì‚¬ìš©ì ì½”ë“œ ì „í™˜ ì‹œ)

---

## âœ… 4. ì˜ˆì™¸ ë°œìƒ ì‹œ ë™ì‘ íë¦„

1. í˜„ì¬ ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ë‹¨
2. xPSR, PC, LR, R0~R3, R12 ë“± ìë™ ì €ì¥ (Exception Stack Frame)
3. PCë¥¼ ë²¡í„° í…Œì´ë¸”ì— ì •ì˜ëœ í•´ë‹¹ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ì£¼ì†Œë¡œ ì„¤ì •
4. í•¸ë“¤ëŸ¬ ì§„ì… â†’ ì‚¬ìš©ì ì½”ë“œ ì‹¤í–‰
5. ë³µê·€ ì‹œ `EXC_RETURN` ê°’ì— ë”°ë¼ ì´ì „ ìƒíƒœ ë³µì›

---

## âœ… 5. Exception Stack Frame

ì˜ˆì™¸ ì§„ì… ì‹œ ìë™ìœ¼ë¡œ í‘¸ì‹œë˜ëŠ” ë ˆì§€ìŠ¤í„° ì§‘í•©:

| ìˆœì„œ | ì €ì¥ í•­ëª© |
|------|------------|
| R0 ~ R3 | í•¨ìˆ˜ ì¸ì/ì‘ì—… ë ˆì§€ìŠ¤í„° |
| R12 | ì„ì‹œ |
| LR (R14) | ë³µê·€ ì£¼ì†Œ |
| PC (R15) | ë³µê·€í•  ëª…ë ¹ì–´ ì£¼ì†Œ |
| xPSR | ìƒíƒœ ë ˆì§€ìŠ¤í„° (ì¡°ê±´ í”Œë˜ê·¸ ë“±) |

---

## âœ… 6. ì˜ˆì™¸ ë³µê·€: EXC_RETURN

ì˜ˆì™¸ì—ì„œ ë¹ ì ¸ë‚˜ê°ˆ ë•Œ PCì— ë“¤ì–´ê°€ëŠ” **íŠ¹ìˆ˜í•œ ìƒìˆ˜ê°’ (0xFFFFFFFx í˜•ì‹)**

| ê°’ | ì˜ë¯¸ |
|-----|------|
| 0xFFFFFFF1 | Handler â†’ Handler (MSP) |
| 0xFFFFFFF9 | Handler â†’ Thread (MSP) |
| 0xFFFFFFFD | Handler â†’ Thread (PSP) |

â†’ ì´ ê°’ì— ë”°ë¼ ë³µê·€ í›„ ì‚¬ìš©í•  ëª¨ë“œ(Handler/Thread), ìŠ¤íƒ(MSP/PSP)ì´ ê²°ì •ë¨.

---

## âœ… 7. ì˜ˆì™¸ ìš°ì„ ìˆœìœ„ ë° ì¤‘ì²© ì²˜ë¦¬

- ìš°ì„ ìˆœìœ„ëŠ” ìˆ«ìê°€ ë‚®ì„ìˆ˜ë¡ ë†’ìŒ.
- ê¸°ë³¸ ê³ ì • ìš°ì„ ìˆœìœ„:
  - Reset = -3, NMI = -2, HardFault = -1
- ê·¸ ì™¸ ì˜ˆì™¸ëŠ” NVICì—ì„œ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ ì„¤ì • ê°€ëŠ¥

### âœ” Tail-Chaining
- ì˜ˆì™¸ í•¸ë“¤ëŸ¬ ë³µê·€ ì „ì— ë” ë†’ì€ ì˜ˆì™¸ê°€ ë°œìƒí•œ ê²½ìš°, ìŠ¤íƒì„ ë³µêµ¬í•˜ì§€ ì•Šê³  ë°”ë¡œ ë‹¤ìŒ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ë¡œ ì§„ì…

### âœ” Late Arrival
- ë³µê·€ ì§ì „ì— ë” ë†’ì€ ì˜ˆì™¸ê°€ ë“¤ì–´ì˜¤ë©´, ë³µê·€ë¥¼ ì·¨ì†Œí•˜ê³  ê·¸ ì˜ˆì™¸ë¡œ ë°”ë¡œ ì „í™˜

---

## âœ… 8. Fault ì˜ˆì™¸ êµ¬ì¡°

FaultëŠ” ì˜¤ë¥˜ì— ëŒ€ì‘í•˜ê¸° ìœ„í•œ ì˜ˆì™¸ì´ë©°, ì¢…ë¥˜ì— ë”°ë¼ ë³„ë„ì˜ í•¸ë“¤ëŸ¬ë¥¼ ë‘˜ ìˆ˜ ìˆë‹¤:

| ì´ë¦„ | ì„¤ëª… | í™œì„±í™” í•„ìš” ì—¬ë¶€ |
|------|------|------------------|
| HardFault | ëª¨ë“  ì˜¤ë¥˜ì˜ ê¸°ë³¸ fallback ì˜ˆì™¸ | í•­ìƒ í™œì„± |
| MemManage | MPU ìœ„ë°˜ ì‹œ | ê¸°ë³¸ ë¹„í™œì„± |
| BusFault | ì˜ëª»ëœ ì£¼ì†Œ ì ‘ê·¼ | ê¸°ë³¸ ë¹„í™œì„± |
| UsageFault | ì˜ëª»ëœ ëª…ë ¹ì–´, divide by zero ë“± | ê¸°ë³¸ ë¹„í™œì„± |

- í™œì„±í™”ëŠ” `SCB->SHCSR` ë ˆì§€ìŠ¤í„°ë¥¼ í†µí•´ ìˆ˜í–‰
- ìƒì„¸ ì›ì¸ì€ `SCB->CFSR`, `HFSR`, `MMFAR`, `BFAR` ë“±ì„ í†µí•´ í™•ì¸ ê°€ëŠ¥

---

## âœ… 9. ì¸í„°ëŸ½íŠ¸ ì»¨íŠ¸ë¡¤: NVIC

- **NVIC**ëŠ” ì¸í„°ëŸ½íŠ¸ í™œì„±í™”, ë¹„í™œì„±í™”, ìš°ì„ ìˆœìœ„ ì§€ì •, ë§ˆìŠ¤í‚¹ ë“±ì„ ë‹´ë‹¹
- ì˜ˆì™¸ ë§ˆìŠ¤í‚¹ ë ˆì§€ìŠ¤í„°:
  - `PRIMASK`: ëª¨ë“  ì¸í„°ëŸ½íŠ¸ ì°¨ë‹¨ (NMI ì œì™¸)
  - `FAULTMASK`: ëª¨ë“  ì˜ˆì™¸ í¬í•¨ ì°¨ë‹¨
  - `BASEPRI`: íŠ¹ì • ìš°ì„ ìˆœìœ„ ì´í•˜ë§Œ ì°¨ë‹¨

---

## âœ… 10. Reset ì˜ˆì™¸ì˜ ë™ì‘

Resetë„ ì˜ˆì™¸ì˜ ì¼ì¢…ì´ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì€ íŠ¹ìˆ˜ì„±ì´ ìˆë‹¤:

- **Thread Modeì—ì„œ ì‹¤í–‰ë¨** (ë‹¤ë¥¸ ì˜ˆì™¸ëŠ” Handler Mode)
- **IPSR ê°’ = 0** (ì˜ˆì™¸ê°€ ì•„ë‹Œ ê²ƒì²˜ëŸ¼ ë³´ì„)
- **ì´ˆê¸° ì§„ì… ì‹œ Thumb ìƒíƒœ + Privileged Access ìƒíƒœ**

---

## âœ… 11. Resetì˜ ì„¸ ê°€ì§€ ìœ í˜•

Cortex-Mì€ ë‹¤ì–‘í•œ ìƒí™©ì—ì„œ Resetì´ ë°œìƒí•  ìˆ˜ ìˆë„ë¡ **ì„¸ ê°€ì§€ ì¢…ë¥˜ì˜ Reset**ì„ ì§€ì›í•œë‹¤:

| ìœ í˜• | ì„¤ëª… |
|------|------|
| **Power-On Reset (POR)** | ì „ì›ì´ ê³µê¸‰ë  ë•Œ ë°œìƒí•˜ë©°, ì¹© ì „ì²´ë¥¼ ì´ˆê¸°í™”í•œë‹¤. ë””ë²„ê·¸ ë¡œì§ í¬í•¨ ì „ì²´ íšŒë¡œ ë¦¬ì…‹ |
| **System Reset** | í”„ë¡œì„¸ì„œì™€ ì£¼ë³€ì¥ì¹˜ë¥¼ ì´ˆê¸°í™”í•˜ë˜, ë””ë²„ê±°ëŠ” ìœ ì§€í•œë‹¤. ì£¼ë¡œ `SCB->AIRCR.SYSRESETREQ`ë¡œ ì†Œí”„íŠ¸ì›¨ì–´ íŠ¸ë¦¬ê±° |
| **Processor Reset** | í”„ë¡œì„¸ì„œ ì½”ì–´ë§Œ ë¦¬ì…‹í•˜ê³ , ì£¼ë³€ì¥ì¹˜ì™€ ë””ë²„ê·¸ ìƒíƒœëŠ” ìœ ì§€ëœë‹¤. `SCB->AIRCR.VECTRESET`ë¡œ ì œì–´ |

---

## âœ… 12. Reset Sequence (ì´ˆê¸°í™” ê³¼ì •)

1. `[0x0000_0000]`ì—ì„œ ì´ˆê¸° Stack Pointer ê°’ì„ ì½ì–´ MSPì— ì„¤ì •
2. `[0x0000_0004]`ì—ì„œ Reset Handler ì£¼ì†Œë¥¼ ì½ì–´ PCì— ì„¤ì •
3. Reset Handler ì‹¤í–‰
4. ì¼ë°˜ì ìœ¼ë¡œ `SystemInit()` â†’ `main()` ìˆœì„œë¡œ ì´ì–´ì§

```c
void Reset_Handler(void) {
    SystemInit();   // í´ëŸ­, ë©”ëª¨ë¦¬ ì´ˆê¸°í™”
    main();         // ì‚¬ìš©ì ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
}
```
